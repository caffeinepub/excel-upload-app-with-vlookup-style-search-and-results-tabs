{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Fix Admin Users approve/reject Principal handling and UI error reporting",
  "requirements": [
    {
      "id": "REQ-5",
      "summary": "Ensure Admin Users approve/reject sends a real Principal object to setApproval (no string cast) to prevent 'Invalid principal argument' runtime errors.",
      "acceptanceCriteria": [
        "From `AdminUsersTab`, clicking Approve on a pending user updates that user to `Approved` without throwing an 'Invalid principal argument' error.",
        "From `AdminUsersTab`, clicking Reject on a pending/approved user updates that user to `Rejected` without throwing an 'Invalid principal argument' error.",
        "The frontend sends a `Principal` value (e.g., `approval.principal` or a `Principal.fromText(...)` result) to `useSetApproval().mutateAsync`, rather than `userPrincipal as any`."
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/AdminUsersTab.tsx",
          "operation": "modify",
          "description": "Update approve/reject handlers to pass `approval.principal` (Principal) directly into `useSetApproval().mutateAsync` (remove `userPrincipal as any`), while keeping string formatting only for display and processing state. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/utils/principal/parsePrincipal.ts",
          "operation": "create",
          "description": "Add a small utility that safely constructs/normalizes a Principal from a value (e.g., Principal instance or text) using `Principal.fromText(...)`, returning a typed success/error result used by Admin approval actions. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/hooks/useApprovalMutations.ts",
          "operation": "modify",
          "description": "Harden `useSetApproval` mutation by normalizing/validating the incoming `user` argument into a real Principal (using the new principal parsing utility) before calling the backend capability, preventing accidental string misuse from any call site. Verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-6",
      "summary": "Add frontend validation and user-facing error handling for approval actions, blocking mutations when Principal parsing fails and showing clear English errors in the Admin Users UI.",
      "acceptanceCriteria": [
        "If an invalid Principal string is ever encountered in the Admin Users page, the UI shows a descriptive error (e.g., 'Invalid Principal ID. Please refresh and try again.') and does not call the backend.",
        "Approval/rejection errors are displayed in the Admin Users page using a user-friendly message (not just console logs)."
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/AdminUsersTab.tsx",
          "operation": "modify",
          "description": "Add local UI state for action errors and display them in the Admin Users page (English). Before calling `mutateAsync`, validate/construct the Principal (via the principal parsing utility); if invalid, show a clear message and skip the mutation. Also map mutation failures to a user-friendly message instead of only console logging. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/utils/errors/userFriendlyError.ts",
          "operation": "modify",
          "description": "Extend `getUserFriendlyError` to recognize Principal-related failures (e.g., messages containing 'invalid principal') and return a clear English message suitable for Admin Users approval actions. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/hooks/useApprovalMutations.ts",
          "operation": "modify",
          "description": "When Principal validation fails in `useSetApproval`, throw an Error with a clear English message so the Admin Users UI can surface it and the backend is not called. Verify the component's usage instructions before implementing."
        }
      ]
    }
  ]
}
{
  "kind": "build_request",
  "title": "User management with admin approval, attendance hours recalculation, work brief notes, and calendar integration",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Implement username/password user management with admin approval required before a user can use the app, including admin CRUD (view/edit/delete) for users.",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-7",
          "msg-8"
        ],
        "quotes": [
          "ADD USER MANAGEMENT. I WILL APROVE AFTER THAT SOMEONE USE THIS APP.",
          "1.YES 2.username/password system. 3.YES"
        ]
      },
      "acceptanceCriteria": [
        "Backend exposes user-management APIs to (a) register with username/password, (b) login with username/password, (c) allow an admin to approve/reject users, (d) allow an admin to list users, update user fields (at minimum username and approval/role), and delete users.",
        "Backend enforces that non-approved users cannot access user-only features (existing calls that currently require #user permission must also require the user to be approved).",
        "Frontend provides screens/components for: (a) registration, (b) login, (c) showing approval status if the user is pending/rejected, and (d) an admin-only user management panel for approve/reject, edit, and delete.",
        "All user-facing text for auth and admin screens is in English.",
        "Existing Internet Identity login remains functional and is not modified in immutable hook paths; new username/password flows are implemented without editing files under frontend/src/hooks/useInternetIdentity.ts(x) or other immutable paths."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Fix and ensure total working time is correctly calculated and updated when attendance check-in/check-out times are set/edited for past dates, and ensure attendance summaries correctly sum totalWorkingTime over the selected range.",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-4",
          "msg-5"
        ],
        "quotes": [
          "DO CALCULATE HOURS WHICH ARE SET IN PAST DATE  AND TIME SETED IN ATTENDANCE",
          "1. IN TOTAL WORKING TIME UPDATE."
        ]
      },
      "acceptanceCriteria": [
        "When an attendance entry is edited for any date (including past dates), the stored workingTime reflects the duration between checkIn and checkOut (and is 0 when either is missing or when the status is a non-working day).",
        "Attendance summary totalWorkingTime equals the sum of workingTime across all entries in the requested range (and does not overwrite/return only a single day’s workingTime).",
        "Frontend attendance summary UI updates after editing an entry (including past entries) without requiring a full page reload.",
        "Invalid time ranges (check-out before check-in) are rejected with a clear English error message."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Add a 'work brief note' text field to each attendance entry, persisted in the backend and editable in the attendance day editor UI.",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-4",
          "msg-5"
        ],
        "quotes": [
          "ALSO ADD WORK BREEF NOTE IN ATTENDANCE.",
          "3.YES"
        ]
      },
      "acceptanceCriteria": [
        "Backend AttendanceDayEntry (or an associated attendance record) stores a brief note field for each date.",
        "Frontend AttendanceDateEditor displays an input (textarea or text input) for the work brief note when editing a date and saves it with the entry.",
        "The note is loaded and shown when reopening an existing attendance entry for a date.",
        "Work brief notes are included in any attendance breakdown data returned by the backend (so they can be used by UI/export features as needed)."
      ]
    },
    {
      "id": "REQ-4",
      "text": "Make the existing Calendar feature functional by wiring calendar event queries/mutations to the backend and integrate attendance with calendar events so attendance entries appear as calendar events.",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-4",
          "msg-5"
        ],
        "quotes": [
          "AND START Calendar Events WORKING.",
          "2. WE HAVE CALANDER FUTURE SO DO WORKING."
        ]
      },
      "acceptanceCriteria": [
        "Frontend Calendar tab lists events from the backend (useGetCalendarEvents returns real data; create/delete mutations call real backend methods).",
        "Creating a calendar event in the Calendar tab persists it and it appears in the events list after creation.",
        "Deleting a calendar event removes it and it disappears from the list after deletion.",
        "Attendance entries appear as calendar events according to a consistent mapping (at minimum: date and working status/time reflected in event title/description), and the mapping does not create duplicate events for the same attendance date on repeated refreshes.",
        "Calendar/attendance integration respects authorization rules (only approved users can manage their own calendar events; admins can manage per the app’s existing authorization conventions)."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single Motoko actor with logic in backend/main.mo; only add backend/migration.mo changes if required by stable state upgrades.",
    "Do not edit files in frontend immutablePaths: frontend/src/hooks/useInternetIdentity.ts, frontend/src/hooks/useInternetIdentity.tsx, frontend/src/hooks/useActor.ts, frontend/src/main.tsx, frontend/src/components/ui.",
    "No external databases or third-party authentication providers; implement username/password and approval using canister state only.",
    "Use English for any user-facing text."
  ],
  "nonGoals": [
    "Adding third-party OAuth/social logins (e.g., Google/GitHub/Facebook/Auth0).",
    "Adding real-time features like WebSockets/push notifications.",
    "Integrating external calendar providers (Google Calendar, Outlook, etc.)."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}